<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="theme-color" content="#0ea5e9" />
  <title>Rockwell, NC ‚Ä¢ NWS Forecast (v2)</title>
  <!-- Leaflet (map) -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""
  ></script>
  <style>
    :root {
      --bg: #0b1220;              /* dark mode default */
      --card: #0f172a;
      --muted: #94a3b8;
      --text: #e2e8f0;
      --accent: #38bdf8;          /* sky-400 */
      --accent-strong: #0ea5e9;    /* sky-500 */
      --ok: #22c55e;
      --warn: #f59e0b;
      --bad: #ef4444;
      --ring: rgba(56,189,248,.45);
      --shadow: 0 10px 25px rgba(2,6,23,.35);
    }
    @media (prefers-color-scheme: light) {
      :root {
        --bg: #f8fafc;
        --card: #ffffff;
        --muted: #475569;
        --text: #0f172a;
        --accent: #0284c7;
        --accent-strong: #0369a1;
        --ring: rgba(2,132,199,.2);
        --shadow: 0 8px 18px rgba(2,8,23,.08);
      }
    }

    html, body { height: 100%; }
    body {
      margin: 0;
      background: linear-gradient(180deg, var(--bg), #0b1328 50%, var(--bg));
      color: var(--text);
      font: 16px/1.4 system-ui, -apple-system, Segoe UI, Roboto, Inter, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
    }

    .container { max-width: 1100px; margin: 0 auto; padding: 16px; }

    header {
      position: sticky; top: 0; z-index: 40;
      backdrop-filter: blur(10px);
      background: color-mix(in oklab, var(--bg) 80%, transparent);
      border-bottom: 1px solid color-mix(in oklab, var(--muted) 25%, transparent);
    }
    .nav {
      display: flex; align-items: center; gap: 12px; padding: 10px 16px; max-width: 1100px; margin: 0 auto;
    }
    .title { font-weight: 800; letter-spacing: .2px; }
    .pill {
      display: inline-flex; gap: 8px; align-items: center;
      background: var(--card); color: var(--text);
      padding: 8px 12px; border-radius: 999px; border: 1px solid color-mix(in oklab, var(--muted) 25%, transparent);
      box-shadow: var(--shadow);
    }
    .btn {
      cursor: pointer; user-select: none;
      border: 0; padding: 8px 12px; border-radius: 10px;
      background: var(--accent); color: white; font-weight: 700;
      box-shadow: var(--shadow);
    }
    .btn:active { transform: translateY(1px); }

    .grid {
      display: grid; grid-template-columns: 1fr; gap: 16px; margin-top: 16px;
    }
    @media (min-width: 900px) {
      .grid { grid-template-columns: 1.15fr .85fr; }
    }

    .card {
      background: var(--card); border-radius: 18px; padding: 14px; box-shadow: var(--shadow);
      border: 1px solid color-mix(in oklab, var(--muted) 20%, transparent);
    }

    #radar { height: 380px; border-radius: 14px; overflow: hidden; }

    .row { display: flex; flex-wrap: wrap; gap: 12px; align-items: center; }
    .row.center { justify-content: center; }

    .kpis { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; }
    @media (min-width: 560px) { .kpis { grid-template-columns: repeat(4, 1fr); } }
    .kpi { background: color-mix(in oklab, var(--card) 96%, black); border: 1px dashed color-mix(in oklab, var(--muted) 25%, transparent); padding: 12px; border-radius: 12px; text-align: center; }
    .kpi .label { color: var(--muted); font-size: 12px; }
    .kpi .value { font-size: 22px; font-weight: 800; }

    .list { display: grid; grid-template-columns: 1fr; gap: 12px; }

    .hourlyScroller {
      display: grid; grid-auto-flow: column; grid-auto-columns: 66%; gap: 10px; overflow-x: auto; padding-bottom: 8px; scroll-snap-type: x mandatory;
    }
    @media (min-width: 560px) { .hourlyScroller { grid-auto-columns: 30%; } }
    @media (min-width: 900px) { .hourlyScroller { grid-auto-columns: 22%; } }

    .hourCard, .dayCard { scroll-snap-align: start; background: color-mix(in oklab, var(--card) 96%, black); border: 1px solid color-mix(in oklab, var(--muted) 25%, transparent); border-radius: 14px; padding: 12px; }
    .hourCard .top, .dayCard .top { display: flex; justify-content: space-between; gap: 10px; align-items: center; }
    .muted { color: var(--muted); font-size: 12px; }
    .temp { font-size: 24px; font-weight: 800; }

    .footnote { color: var(--muted); font-size: 12px; margin-top: 8px; }
    .lastUpdated { font-size: 12px; color: var(--muted); }

    .statusDot { width: 8px; height: 8px; border-radius: 999px; display: inline-block; background: var(--accent-strong); box-shadow: 0 0 0 4px var(--ring); }

    .loading { opacity: .7; }

    a, a:visited { color: var(--accent); text-decoration: none; }

    .attribution { font-size: 11px; color: var(--muted); display: flex; flex-wrap: wrap; gap: 6px; align-items: center; }
    .attribution span { white-space: nowrap; }

    /* HR Lake stats */
    .hrGrid { display: grid; grid-template-columns: 1fr; gap: 12px; }
    @media (min-width: 800px){ .hrGrid { grid-template-columns: 1.2fr .8fr; } }
    .sparklineWrap { background: color-mix(in oklab, var(--card) 96%, black); border: 1px solid color-mix(in oklab, var(--muted) 25%, transparent); border-radius: 14px; padding: 12px; }
    .sparklineHead { display:flex; justify-content:space-between; align-items:center; margin-bottom:8px }
    .legend { display:flex; gap:10px; align-items:center }
    .legItem { display:flex; gap:6px; align-items:center; font-size:12px; color:var(--muted) }
    .swatch { width: 18px; height: 3px; border-radius: 2px; background: var(--accent); display:inline-block }
    .swatch.median { background: #22c55e }
    .swatch.full { background: #eab308 }

    .radarControls .label { font-size: 12px; color: var(--muted);}
    .range { width: 160px; }
  </style>
</head>
<body>
  <header>
    <nav class="nav">
      <div class="pill" title="Live">
        <span class="statusDot"></span>
        <span>Rockwell, NC</span>
      </div>
      <div style="flex:1"></div>
      <strong class="title">NWS Forecast</strong>
      <div style="flex:1"></div>
      <button id="refreshBtn" class="btn" aria-label="Refresh forecast">Refresh</button>
    </nav>
  </header>

  <main class="container">
    <section class="grid">
      <div class="card">
        <h2 style="margin:6px 4px 10px">Radar</h2>
        <div id="radar" aria-label="Radar map for Rockwell, NC"></div>
        <div id="radarControls" class="row radarControls" style="margin-top:10px; gap:10px">
          <div class="row" style="gap:8px">
            <span class="label">Mode</span>
            <button data-mode="auto" class="btn sm" id="modeAuto">Auto</button>
            <button data-mode="animated" class="btn sm" id="modeAnim">Animated</button>
            <button data-mode="static" class="btn sm" id="modeStatic">Static</button>
            <button data-mode="off" class="btn sm" id="modeOff">Off</button>
          </div>
          <div style="flex:1"></div>
          <div class="row" style="gap:10px">
            <label class="label" for="frameSlider">Frame</label>
            <input id="frameSlider" class="range" type="range" min="0" max="0" value="0" aria-label="Radar time slider" />
            <span id="frameTime" class="muted">‚Äî</span>
          </div>
        </div>
        <div class="row" style="gap:14px; margin-top:8px">
          <div class="row" style="gap:8px">
            <span class="label">Max frames</span>
            <input id="maxFrames" class="range" type="range" min="6" max="60" value="24" />
            <span id="maxFramesLbl" class="muted">24</span>
          </div>
          <div class="row" style="gap:8px">
            <span class="label">Speed</span>
            <input id="speedSlider" class="range" type="range" min="120" max="800" step="20" value="450" />
            <span id="speedLbl" class="muted">450 ms</span>
          </div>
          <div class="row" style="gap:8px">
            <span class="label">Opacity</span>
            <input id="opacitySlider" class="range" type="range" min="20" max="100" value="60" />
            <span id="opacityLbl" class="muted">0.60</span>
          </div>
          <button id="playBtn" class="btn" aria-label="Play/Pause radar animation">Play</button>
        </div>
        <div class="footnote attribution" style="margin-top:8px">
          <span>Animated tiles: RainViewer</span>
          <span>‚Ä¢</span>
          <span>Static fallback: NEXRAD (Iowa State Mesonet)</span>
          <span>‚Ä¢</span>
          <span>Map ¬© OpenStreetMap</span>
          <span>‚Ä¢</span>
          <span id="radarDiag" class="muted"></span>
        </div>
      </div>
      <div class="card">
        <h2 style="margin:6px 4px 10px">Right now</h2>
        <div class="kpis">
          <div class="kpi"><div class="label">Current Temp</div><div id="nowTemp" class="value">‚Äî</div></div>
          <div class="kpi"><div class="label">Heat Index</div><div id="heatIndex" class="value">‚Äî</div></div>
          <div class="kpi"><div class="label">Chance of Rain (6h)</div><div id="pop6" class="value">‚Äî</div></div>
          <div class="kpi"><div class="label">Wind (now)</div><div id="windNow" class="value">‚Äî</div></div>
        </div>
        <div style="display:flex;justify-content:space-between;align-items:center;margin-top:10px">
          <div class="lastUpdated" id="lastUpdated">Loading‚Ä¶</div>
          <div class="footnote">Data: <a href="https://api.weather.gov/" target="_blank" rel="noreferrer noopener">NWS</a></div>
        </div>
      </div>
    </section>

    <section class="card">
      <h2 style="margin:6px 4px 12px">Lake levels</h2>
      <div id="lakes" class="list"></div>
      <div class="footnote attribution" style="margin-top:8px">
        <span>Sources: USGS NWIS, NOAA NWPS, Cube Carolinas</span>
      </div>
    </section>

    <section class="card">
      <h2 style="margin:6px 4px 12px">High Rock Lake ‚Äî detailed stats</h2>
      <div class="hrGrid">
        <div>
          <div class="kpis" style="margin-bottom:12px">
            <div class="kpi"><div class="label">Current Elevation</div><div id="hrNow" class="value">‚Äî</div></div>
            <div class="kpi"><div class="label">vs Full Pond (655.00)</div><div id="hrVsFull" class="value">‚Äî</div></div>
            <div class="kpi"><div class="label">Change (24h)</div><div id="hrCh24" class="value">‚Äî</div></div>
            <div class="kpi"><div class="label">Change (7d)</div><div id="hrCh7" class="value">‚Äî</div></div>
          </div>
          <div class="sparklineWrap">
            <div class="sparklineHead">
              <div class="legend">
                <div class="legItem"><span class="swatch"></span><span>Last 30 days</span></div>
                <div class="legItem"><span class="swatch median"></span><span>Median (today)</span></div>
                <div class="legItem"><span class="swatch full"></span><span>Full pond</span></div>
              </div>
              <div class="muted" id="hrRange">‚Äî</div>
            </div>
            <svg id="hrSpark" viewBox="0 0 600 150" width="100%" height="150" aria-label="High Rock Lake 30-day sparkline"></svg>
          </div>
          <div class="row" style="margin-top:10px; gap:10px">
            <button id="dlCsv" class="btn">Download 30‚Äëday CSV</button>
            <div class="footnote" id="hrMeta">Data: USGS NWIS gage 02122500 (gage height + datum 558.68 = pool ft)</div>
          </div>
        </div>
        <div class="list">
          <div class="dayCard">
            <div class="top"><div><div style="font-weight:800">Today vs historical</div><div class="muted">Based on USGS daily stats (period of record)</div></div></div>
            <div style="margin-top:10px; display:grid; grid-template-columns: 1fr; gap:8px">
              <div><span class="muted">Median today:</span> <strong id="hrMed">‚Äî</strong></div>
              <div><span class="muted">Mean today:</span> <strong id="hrMean">‚Äî</strong></div>
              <div><span class="muted">Percentile rank:</span> <strong id="hrPctile">‚Äî</strong></div>
              <div><span class="muted">30‚Äëday min / max / mean:</span> <strong id="hrMinMax">‚Äî</strong></div>
              <div><span class="muted">Same date last year:</span> <strong id="hrLastYear">‚Äî</strong></div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <section class="card">
      <h2 style="margin:6px 4px 12px">Hourly (next 12 hours)</h2>
      <div id="hourly" class="hourlyScroller loading"></div>
    </section>

    <section class="card">
      <h2 style="margin:6px 4px 12px">Daily (next 7 days)</h2>
      <div id="daily" class="list loading"></div>
    </section>

    <p class="footnote">
      Tip: Add this page to your phone‚Äôs home screen for quick access. Values refresh when you tap <strong>Refresh</strong>.
    </p>
  </main>

  <script>
    // --- Configuration for Rockwell, NC ---
    const LAT = 35.551;   // Rockwell, NC approx
    const LON = -80.407;

    // --- Map (Leaflet + OSM base) ---
    const map = L.map('radar', { zoomControl: true, attributionControl: true }).setView([LAT, LON], 9);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 18,
      attribution: 'Map data ¬© OpenStreetMap contributors'
    }).addTo(map);

    // Static fallback radar (NEXRAD via Iowa State Mesonet)
    let radarLayer = L.tileLayer(
      'https://mesonet.agron.iastate.edu/cache/tile.py/1.0.0/ridge::USCOMP-N0Q-0/{z}/{x}/{y}.png',
      { opacity: 0.6, zIndex: 500, attribution: 'Radar ¬© Iowa State Mesonet / NWS NEXRAD' }
    ).addTo(map);

    const marker = L.circleMarker([LAT, LON], {
      radius: 6,
      color: '#0ea5e9',
      fillColor: '#38bdf8',
      fillOpacity: 0.95,
      weight: 2
    }).addTo(map).bindPopup('Rockwell, NC');

    // --- RainViewer animated radar (frames + controls) ---
    let rainFrames = [];
    let rainLayer = null;
    let frameIndex = 0;
    let animTimer = null;
    let isPlaying = false;
    let currentMode = 'auto'; // auto | animated | static | off

    // Heuristic performance cap for frames
    const DEVICE_MEM = navigator.deviceMemory || 4;
    const IS_MOBILE = /Mobi|Android/i.test(navigator.userAgent);
    const RECOMMENDED_MAX_FRAMES = Math.min(60, IS_MOBILE ? 24 : (DEVICE_MEM >= 8 ? 48 : DEVICE_MEM >= 4 ? 36 : 24));
    let MAX_FRAMES = RECOMMENDED_MAX_FRAMES;
    let FRAME_INTERVAL = 450; // ms
    let LAYER_OPACITY = 0.6;

    function rvFrameUrl(t){
      return `https://tilecache.rainviewer.com/v2/radar/${t}/256/{z}/{x}/{y}/2/1_1.png`;
    }

    function ensureRainLayer(){
      if (!rainLayer) {
        rainLayer = L.tileLayer(rvFrameUrl(rainFrames[frameIndex] || 0), { opacity: LAYER_OPACITY, zIndex: 550 });
      }
      return rainLayer;
    }

    function setRadarOpacity(v){
      LAYER_OPACITY = v;
      if (radarLayer) radarLayer.setOpacity(v);
      if (rainLayer) rainLayer.setOpacity(v);
    }

    function showFrame(i){
      if (!rainFrames.length) return;
      frameIndex = (i + rainFrames.length) % rainFrames.length;
      const t = rainFrames[frameIndex];
      if (rainLayer) {
        rainLayer.setUrl(rvFrameUrl(t));
      } else {
        rainLayer = L.tileLayer(rvFrameUrl(t), { opacity: LAYER_OPACITY, zIndex: 550 });
        if (currentMode === 'animated' || currentMode === 'auto') rainLayer.addTo(map);
      }
      const slider = document.getElementById('frameSlider');
      const label = document.getElementById('frameTime');
      if (slider) slider.value = String(frameIndex);
      if (label) label.textContent = new Date(t * 1000).toLocaleString();
    }

    function play(){
      if (animTimer || !rainFrames.length) return;
      isPlaying = true; updatePlayBtn();
      animTimer = setInterval(() => showFrame(frameIndex + 1), FRAME_INTERVAL);
    }
    function pause(){
      isPlaying = false; updatePlayBtn();
      if (animTimer) { clearInterval(animTimer); animTimer = null; }
    }
    function updatePlayBtn(){
      const btn = document.getElementById('playBtn');
      if (btn) btn.textContent = isPlaying ? 'Pause' : 'Play';
    }

    function setMode(mode){
      currentMode = mode;
      // Remove/add layers per mode
      if (mode === 'off') {
        if (radarLayer && map.hasLayer(radarLayer)) map.removeLayer(radarLayer);
        if (rainLayer && map.hasLayer(rainLayer)) map.removeLayer(rainLayer);
        document.getElementById('radarDiag').textContent = 'Radar off';
        return;
      }
      if (mode === 'static') {
        if (rainLayer && map.hasLayer(rainLayer)) map.removeLayer(rainLayer);
        if (radarLayer && !map.hasLayer(radarLayer)) radarLayer.addTo(map);
        document.getElementById('radarDiag').textContent = 'Static NEXRAD tiles';
        return;
      }
      // animated or auto -> prefer RainViewer frames if available
      if (radarLayer && map.hasLayer(radarLayer)) map.removeLayer(radarLayer);
      if (rainLayer && !map.hasLayer(rainLayer)) rainLayer.addTo(map);
      document.getElementById('radarDiag').textContent = `Animated RainViewer ‚Ä¢ ${rainFrames.length} frames @ ${FRAME_INTERVAL}ms`;
    }

    async function initRadarAnimation(){
      try {
        const res = await fetch('https://tilecache.rainviewer.com/api/maps.json');
        const data = await res.json();
        let frames = [];
        if (data && data.radar) {
          const past = Array.isArray(data.radar.past) ? data.radar.past : [];
          const nowc = Array.isArray(data.radar.nowcast) ? data.radar.nowcast : [];
          frames = past.concat(nowc).map(f => f.time).filter(Boolean);
        } else if (Array.isArray(data)) {
          frames = data; // older API shape
        }
        // Keep only the most recent MAX_FRAMES frames (past+nowcast)
        rainFrames = frames.slice(-MAX_FRAMES);

        const slider = document.getElementById('frameSlider');
        if (rainFrames.length && slider) {
          slider.max = String(rainFrames.length - 1);
          showFrame(rainFrames.length - 1);
          // Prefer animated layer by default in auto mode
          setMode(currentMode);
          // If animated is available, drop static to avoid double overlay
          if (typeof radarLayer !== 'undefined' && map.hasLayer(radarLayer) && (currentMode === 'animated' || currentMode === 'auto')) {
            map.removeLayer(radarLayer);
          }
          document.getElementById('radarDiag').textContent = `Recommended max frames: ${RECOMMENDED_MAX_FRAMES} ‚Ä¢ Using: ${MAX_FRAMES}`;
        } else {
          // Hide certain controls if frames unavailable
          const controls = document.getElementById('radarControls');
          if (controls) controls.style.opacity = '0.6';
          document.getElementById('radarDiag').textContent = 'RainViewer frames unavailable; showing static NEXRAD.';
          setMode('static');
        }
      } catch (e) {
        console.error('RainViewer init failed', e);
        document.getElementById('radarDiag').textContent = 'Animated radar failed; showing static NEXRAD.';
        setMode('static');
      }
    }

    // UI wire-up for radar controls
    document.getElementById('playBtn')?.addEventListener('click', () => {
      if (isPlaying) pause(); else play();
    });
    document.getElementById('frameSlider')?.addEventListener('input', (e) => {
      pause();
      const v = parseInt(e.target.value, 10) || 0;
      showFrame(v);
    });
    document.getElementById('maxFrames')?.addEventListener('input', (e) => {
      const v = Math.max(6, Math.min(60, parseInt(e.target.value, 10) || RECOMMENDED_MAX_FRAMES));
      MAX_FRAMES = v;
      document.getElementById('maxFramesLbl').textContent = String(v);
    });
    document.getElementById('maxFrames')?.addEventListener('change', () => {
      // reinitialize with new cap
      pause();
      initRadarAnimation();
    });
    document.getElementById('speedSlider')?.addEventListener('input', (e) => {
      const v = Math.max(120, Math.min(800, parseInt(e.target.value, 10) || 450));
      FRAME_INTERVAL = v;
      document.getElementById('speedLbl').textContent = v + ' ms';
      if (isPlaying) { pause(); play(); }
    });
    document.getElementById('opacitySlider')?.addEventListener('input', (e) => {
      const v = (Math.max(20, Math.min(100, parseInt(e.target.value, 10) || 60))) / 100;
      document.getElementById('opacityLbl').textContent = v.toFixed(2);
      setRadarOpacity(v);
    });
    document.getElementById('modeAuto')?.addEventListener('click', () => setMode('auto'));
    document.getElementById('modeAnim')?.addEventListener('click', () => setMode('animated'));
    document.getElementById('modeStatic')?.addEventListener('click', () => setMode('static'));
    document.getElementById('modeOff')?.addEventListener('click', () => setMode('off'));

    // --- Helpers ---
    const $ = (id) => document.getElementById(id);
    const fmtTime = (dStr, opts={}) => new Intl.DateTimeFormat(undefined, { hour: 'numeric', minute: '2-digit', ...opts }).format(new Date(dStr));
    const fmtDay = (dStr) => new Intl.DateTimeFormat(undefined, { weekday: 'short' }).format(new Date(dStr));

    // Heat Index (NOAA Rothfusz regression with adjustments)
    function heatIndexF(tempF, rh) {
      const T = tempF;
      const R = rh;
      if (T == null || R == null) return null;
      if (T < 80 || R < 40) return Math.round(T);
      let HI = -42.379 + 2.04901523*T + 10.14333127*R - 0.22475541*T*R - 0.00683783*T*T - 0.05481717*R*R + 0.00122874*T*T*R + 0.00085282*T*R*R - 0.00000199*T*T*R*R;
      if (R < 13 && T >= 80 && T <= 112) HI -= ((13 - R)/4) * Math.sqrt((17 - Math.abs(T - 95))/17);
      if (R > 85 && T >= 80 && T <= 87) HI += ((R - 85)/10) * ((87 - T)/5);
      return Math.round(HI);
    }

    function popVal(obj) {
      if (!obj) return null;
      const v = obj.value; // % or null
      return typeof v === 'number' ? v : null;
    }

    function windNowText(period) {
      if (!period) return '‚Äî';
      const dir = period.windDirection || '';
      const spd = (period.windSpeed || '').replace(/ to /, '‚Äì');
      return `${dir} ${spd}`.trim() || '‚Äî';
    }

    // --- Fetch NWS endpoints ---
    async function loadForecast() {
      $('lastUpdated').textContent = 'Loading‚Ä¶';
      $('hourly').classList.add('loading');
      $('daily').classList.add('loading');

      const pointsUrl = `https://api.weather.gov/points/${LAT},${LON}`;
      const points = await fetch(pointsUrl, { headers: { 'Accept': 'application/geo+json' } }).then(r => r.json());

      const hourlyUrl = points?.properties?.forecastHourly;
      const dailyUrl  = points?.properties?.forecast;

      if (!hourlyUrl || !dailyUrl) {
        $('lastUpdated').textContent = 'Could not load NWS endpoints.';
        return;
      }

      const [hourly, daily] = await Promise.all([
        fetch(hourlyUrl, { headers: { 'Accept': 'application/geo+json' } }).then(r => r.json()),
        fetch(dailyUrl,  { headers: { 'Accept': 'application/geo+json' } }).then(r => r.json())
      ]);

      renderHourly(hourly?.properties?.periods || []);
      renderDaily(daily?.properties?.periods || []);

      // KPIs (now = first hourly period)
      const now = (hourly?.properties?.periods || [])[0];
      const nowTemp = now?.temperature;
      const nowRH = now?.relativeHumidity?.value;
      const nowHI = heatIndexF(nowTemp, nowRH);
      $('nowTemp').textContent = nowTemp != null ? `${Math.round(nowTemp)}¬∞F` : '‚Äî';
      $('heatIndex').textContent = nowHI != null ? `${nowHI}¬∞F` : '‚Äî';
      $('windNow').textContent = windNowText(now);

      // Chance of rain next 6h (max of next 6 hourly pops)
      const next6 = (hourly?.properties?.periods || []).slice(0, 6);
      const pops = next6.map(p => popVal(p.probabilityOfPrecipitation)).filter(v => typeof v === 'number');
      const maxPop = pops.length ? Math.max(...pops) : NaN;
      $('pop6').textContent = isFinite(maxPop) ? `${Math.round(maxPop)}%` : '‚Äî';

      $('lastUpdated').textContent = 'Updated ' + new Intl.DateTimeFormat(undefined, { dateStyle: 'medium', timeStyle: 'short' }).format(new Date());
    }

    function renderHourly(periods) {
      const cont = $('hourly');
      cont.innerHTML = '';
      periods.slice(0, 12).forEach(p => {
        const div = document.createElement('div');
        div.className = 'hourCard';
        const icon = p.icon ? `<img src="${p.icon}" alt="${p.shortForecast}" style="width:36px;height:36px;border-radius:8px;object-fit:cover"/>` : '';
        const pop = popVal(p.probabilityOfPrecipitation);
        div.innerHTML = `
          <div class="top">
            <div>
              <div class="muted">${fmtDay(p.startTime)} ‚Ä¢ ${fmtTime(p.startTime)}</div>
              <div class="temp">${Math.round(p.temperature)}¬∞F</div>
            </div>
            ${icon}
          </div>
          <div class="muted" style="margin-top:6px">${p.shortForecast || ''}</div>
          <div class="row" style="margin-top:8px">
            <div class="pill" title="Chance of precipitation"><span>üåßÔ∏è</span><strong>${isFinite(pop) ? pop + '%' : '‚Äî'}</strong></div>
            <div class="pill" title="Wind"><span>üí®</span><strong>${windNowText(p)}</strong></div>
          </div>
        `;
        cont.appendChild(div);
      });
      cont.classList.remove('loading');
    }

    function renderDaily(periods) {
      const cont = $('daily');
      cont.innerHTML = '';
      // Use daytime periods for a clean 7-day overview
      const days = periods.filter(p => p.isDaytime).slice(0, 7);
      days.forEach(p => {
        const div = document.createElement('div');
        div.className = 'dayCard';
        const pop = popVal(p.probabilityOfPrecipitation);
        const icon = p.icon ? `<img src="${p.icon}" alt="${p.shortForecast}" style="width:44px;height:44px;border-radius:10px;object-fit:cover"/>` : '';
        div.innerHTML = `
          <div class="top">
            <div>
              <div style="font-weight:800">${p.name}</div>
              <div class="muted">${p.shortForecast || ''}</div>
            </div>
            ${icon}
          </div>
          <div class="row" style="margin-top:10px">
            <div class="pill"><span>üå°Ô∏è</span><strong>${Math.round(p.temperature)}¬∞F</strong></div>
            <div class="pill"><span>üåßÔ∏è</span><strong>${isFinite(pop) ? pop + '%' : '‚Äî'}</strong></div>
            <div class="pill"><span>üí®</span><strong>${windNowText(p)}</strong></div>
          </div>
        `;
        cont.appendChild(div);
      });
      cont.classList.remove('loading');
    }

    // --- Lake Levels (High Rock & Tuckertown) ---
    const USGS_HIGHROCK_SITE = '02122500';
    const USGS_HIGHROCK_DATUM_FT = 558.68; // NGVD29 (USGS inventory)
    const FULL_POND = { highrock: 655, tuckertown: 596 };

    async function fetchHighRockFromUSGS(){
      try {
        const url = `https://waterservices.usgs.gov/nwis/iv/?format=json&sites=${USGS_HIGHROCK_SITE}&parameterCd=00065&siteStatus=all`;
        const data = await fetch(url).then(r => r.json());
        const ts = data?.value?.timeSeries?.[0];
        const arr = ts?.values?.[0]?.value || [];
        const last = arr[arr.length - 1];
        const gageFt = parseFloat(last?.value);
        const when = last?.dateTime;
        if (isFinite(gageFt)) {
          return { value: +(USGS_HIGHROCK_DATUM_FT + gageFt).toFixed(2), when, src: 'USGS' };
        }
      } catch(err){ console.warn('USGS fetch failed', err); }
      return null;
    }

    async function fetchFromCube(){
      const candidates = [
        'https://r.jina.ai/https://cubecarolinas.com/lake-levels/',
        'https://r.jina.ai/http://cubecarolinas.com/lake-levels/',
        'https://r.jina.ai/https://www.cubecarolinas.com/lake-levels/',
        'https://r.jina.ai/https://cubecarolinas.com/current-lake-levels/'
      ];
      const parse = (html) => {
        const find = (names) => {
          for (const name of names) {
            const re = new RegExp(name + "[^0-9]*([0-9]{3}(?:\.[0-9]+)?)", 'i');
            const m = html.match(re);
            if (m) return parseFloat(m[1]);
          }
          return null;
        };
        return {
          hr: find(['High Rock Lake','High Rock']),
          tt: find(['Tuckertown Lake','Tuckertown'])
        };
      };
      for (const url of candidates) {
        try {
          const html = await fetch(url).then(r => r.text());
          if (!html) continue;
          const { hr, tt } = parse(html);
          const now = new Date().toISOString();
          const result = {
            highrock: hr != null ? { value: +(+hr).toFixed(2), when: now, src: 'Cube Carolinas' } : null,
            tuckertown: tt != null ? { value: +(+tt).toFixed(2), when: now, src: 'Cube Carolinas' } : null
          };
          if (result.highrock || result.tuckertown) return result;
        } catch(err){ console.warn('Cube levels fetch failed', url, err); }
      }
      return { highrock: null, tuckertown: null };
    }

    async function fetchHighRockFromNOAA(){
      try {
        const text = await fetch('https://r.jina.ai/http://water.noaa.gov/gauges/hgrn7').then(r => r.text());
        const m = text.match(/Pool \(FT\)[^0-9]*([0-9]{3}\.[0-9]+)/i);
        if (m) return { value: +parseFloat(m[1]).toFixed(2), when: new Date().toISOString(), src: 'NOAA NWPS' };
      } catch(err){ console.warn('NOAA NWPS fetch failed', err); }
      return null;
    }

    function renderLakeLevels(vals){
      const cont = $('lakes');
      if (!cont) return;
      cont.innerHTML = '';
      const addRow = (label, item, full) => {
        const div = document.createElement('div');
        div.className = 'dayCard';
        let valueText = '‚Äî';
        let sub = '';
        if (item && isFinite(item.value)) {
          const diff = (full != null) ? +(full - item.value).toFixed(2) : null;
          const dir = diff != null ? (diff >= 0 ? 'below' : 'above') : '';
          const mag = diff != null ? Math.abs(diff).toFixed(2) : '';
          valueText = `${item.value.toFixed(2)} ft`;
          sub = (diff != null) ? `${mag} ft ${dir} full (${full} ft)` : '';
        }
        div.innerHTML = `
          <div class="top">
            <div>
              <div style="font-weight:800">${label}</div>
              <div class="muted">${sub || ''}</div>
            </div>
            <div class="temp">${valueText}</div>
          </div>
          <div class="footnote">${item?.src ? 'Source: ' + item.src : ''}</div>
        `;
        cont.appendChild(div);
      };
      addRow('High Rock Lake', vals.highrock, FULL_POND.highrock);
      addRow('Tuckertown Lake', vals.tuckertown, FULL_POND.tuckertown);
    }

    async function loadLakeLevels(){
      const vals = { highrock: null, tuckertown: null };
      // Try operator site first for both
      const cube = await fetchFromCube();
      if (cube.highrock) vals.highrock = cube.highrock;
      if (cube.tuckertown) vals.tuckertown = cube.tuckertown;
      // High Rock fallbacks
      if (!vals.highrock) vals.highrock = await fetchHighRockFromUSGS();
      if (!vals.highrock) vals.highrock = await fetchHighRockFromNOAA();
      renderLakeLevels(vals);
    }

    // --- High Rock detailed stats ---
    function toPoolFt(gageFt){ return USGS_HIGHROCK_DATUM_FT + gageFt; }

    async function fetchHRSeries(days=30){
      // Instantaneous values for the last N days
      const url = `https://waterservices.usgs.gov/nwis/iv/?format=json&sites=${USGS_HIGHROCK_SITE}&parameterCd=00065&siteStatus=all&period=P${days}D`;
      const data = await fetch(url).then(r => r.json());
      const arr = data?.value?.timeSeries?.[0]?.values?.[0]?.value || [];
      return arr.map(p => ({ t: new Date(p.dateTime), v: toPoolFt(parseFloat(p.value)) }))
               .filter(p => isFinite(p.v));
    }

    async function fetchHRStatsDaily(){
      // Daily statistics (percentiles by day-of-year)
      const url = `https://waterservices.usgs.gov/nwis/stat/?format=rdb&sites=${USGS_HIGHROCK_SITE}&parameterCd=00065&statReportType=daily&statTypeCd=all`;
      try {
        const res = await fetch(url);
        if (!res.ok) throw new Error('stat service error ' + res.status);
        const text = await res.text();
        const lines = text.split(/\r?\n/).filter(l => l && !l.startsWith('#'));
        
        const headerIdx = lines.findIndex(l => /month_nu/.test(l) && /day_nu/.test(l));
        if (headerIdx === -1) {
          console.warn('Could not find header row in USGS stats response.');
          return null;
        }
        
        const cols = lines[headerIdx].trim().split(/\t/);
        const idx = (name) => cols.indexOf(name);
        const ixMonth = idx('month_nu');
        const ixDay = idx('day_nu');
        const ixP50 = idx('p50_va');
        const ixMean = idx('mean_va');
        const ixMin = idx('min_va');
        const ixMax = idx('max_va');

        if ([ixMonth, ixDay, ixP50, ixMean, ixMin, ixMax].some(i => i < 0)) {
            console.warn('Could not find all required columns in USGS stats response.');
            return null;
        }
        
        const statMap = new Map();
        const mapKey = (m,d) => (`${String(m).padStart(2,'0')}-${String(d).padStart(2,'0')}`);
        
        for (let i = headerIdx + 1; i < lines.length; i++){
          const line = lines[i];
          
          // More robustly skip non-data lines. Data lines start with "USGS".
          if (!line.startsWith('USGS')) {
              continue;
          }

          const r = line.split(/\t/);
          
          const maxIndex = Math.max(ixMonth, ixDay, ixP50, ixMean, ixMin, ixMax);
          if (r.length <= maxIndex) {
              continue;
          }

          const m = parseInt(r[ixMonth], 10);
          const d = parseInt(r[ixDay], 10);
          const p50 = parseFloat(r[ixP50]);
          const mean = parseFloat(r[ixMean]);
          const vmin = parseFloat(r[ixMin]);
          const vmax = parseFloat(r[ixMax]);
          
          if (![m, d, p50, mean, vmin, vmax].every(Number.isFinite)) {
            continue;
          }
          
          statMap.set(mapKey(m,d), {
            median: toPoolFt(p50),
            mean: toPoolFt(mean),
            min: toPoolFt(vmin),
            max: toPoolFt(vmax),
          });
        }
        return statMap.size ? statMap : null;
      } catch(err){
        console.error('USGS stats fetch failed', err);
        return null;
      }
    }

    function percentileRank(value, { min, max, median }){
      if (value == null || min == null || max == null || median == null) return null;
      if (value <= min) return 0;
      if (value >= max) return 100;
      // Linear interpolation between min-median and median-max
      let pct = 50;
      if (value < median) {
        pct = 50 * (value - min) / (median - min);
      } else {
        pct = 50 + 50 * (value - median) / (max - median);
      }
      return Math.round(pct);
    }

    function formatDelta(d){
      if (d == null || !isFinite(d)) return '‚Äî';
      const sign = d >= 0 ? '+' : '‚àí';
      return `${sign}${Math.abs(d).toFixed(2)} ft`;
    }

    function drawSparkline(svgId, data, hlines = []) {
      const svg = document.getElementById(svgId);

      const pad = 0.05 * (maxV - minV);
      const yMin = minV - pad, yMax = maxV + pad;

      const toX = (t) => (t - minT) / (maxT - minT) * w;
      const toY = (v) => h - ((v - yMin) / (yMax - yMin) * h);

      if (data.length === 1) {
        const pt = data[0];
        const circle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
        circle.setAttribute('cx', String(w / 2));
        circle.setAttribute('cy', String(toY(pt.v)));
        circle.setAttribute('r', '3');
        circle.setAttribute('fill', 'var(--accent)');
        svg.appendChild(circle);
      } else {
        const pathData = data
          .map((p, i) => `${i === 0 ? 'M' : 'L'} ${toX(p.t.getTime()).toFixed(2)} ${toY(p.v).toFixed(2)}`)
          .join(' ');
        const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
        path.setAttribute('d', pathData);
        path.setAttribute('fill', 'none');
        path.setAttribute('stroke', 'var(--accent)');
        path.setAttribute('stroke-width', '2.5');
        path.setAttribute('stroke-linejoin', 'round');
        svg.appendChild(path);
      }

      if (hlines && hlines.length) {
        for (const hl of hlines) {
          const y = toY(hl.value);
          if (y < 0 || y > h) continue;
          const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
          line.setAttribute('x1', '0');
          line.setAttribute('y1', String(y));
          line.setAttribute('x2', String(w));
          line.setAttribute('y2', String(y));
          line.setAttribute('stroke', hl.color || 'var(--muted)');
          line.setAttribute('stroke-width', '1.5');
          line.setAttribute('stroke-dasharray', '4 4');
          line.setAttribute('opacity', '0.9');
          svg.appendChild(line);
        }
      }
    }

    async function loadHighRockDetails(){
      try {
        // Fetch series & stats in parallel
        const [series30, statMap] = await Promise.all([
          fetchHRSeries(30).catch(() => []),
          fetchHRStatsDaily().catch(() => null)
        ]);
        if (!series30.length){
          document.getElementById('hrMeta').textContent = 'High Rock stats unavailable (USGS series not returned).';
          return;
        }
        const last = series30[series30.length - 1];
        const nowFt = last.v;
        const full = FULL_POND.highrock;
        const vsFull = (nowFt - full);

        // 24h & 7d deltas
        const nowMs = last.t.getTime();
        const findAgo = (hrs) => {
          const target = nowMs - hrs*3600*1000;
          // find earliest point after target
          for (let i=0; i<series30.length; i++){
            if (series30[i].t.getTime() >= target) return series30[i].v;
          }
          return series30[0].v;
        };
        const v24 = findAgo(24);
        const v7d = findAgo(24*7);
        const d24 = nowFt - v24;
        const d7 = nowFt - v7d;

        // 30-day stats
        const vals = series30.map(p => p.v);
        const vmin = Math.min(...vals);
        const vmax = Math.max(...vals);
        const vmean = vals.reduce((a,b)=>a+b,0)/vals.length;

        $('hrNow').textContent = nowFt.toFixed(2) + ' ft';
        $('hrVsFull').textContent = (vsFull >= 0 ? '+' : '‚àí') + Math.abs(vsFull).toFixed(2) + ' ft';
        $('hrCh24').textContent = formatDelta(d24);
        $('hrCh7').textContent = formatDelta(d7);
        $('hrMinMax').textContent = `${vmin.toFixed(2)} / ${vmax.toFixed(2)} / ${vmean.toFixed(2)} ft`;

        // Historical daily stats for today
        const today = new Date();
        const key = `${String(today.getMonth()+1).padStart(2,'0')}-${String(today.getDate()).padStart(2,'0')}`;
        const statsToday = statMap?.get(key) || null;
        if (statsToday && [statsToday.median, statsToday.mean].every(Number.isFinite)) {
          $('hrMed').textContent = statsToday.median.toFixed(2) + ' ft';
          $('hrMean').textContent = statsToday.mean.toFixed(2) + ' ft';
          const pr = percentileRank(nowFt, statsToday);
          $('hrPctile').textContent = pr != null ? `${pr}th percentile` : '‚Äî';
        } else {
          $('hrMed').textContent = '‚Äî';
          $('hrMean').textContent = '‚Äî';
          $('hrPctile').textContent = '‚Äî';
        }

        // Same date last year
        try {
          const lastYearStart = new Date(today.getFullYear()-1, today.getMonth(), today.getDate()-1);
          const lastYearEnd = new Date(today.getFullYear()-1, today.getMonth(), today.getDate()+1);
          const urlLY = `https://waterservices.usgs.gov/nwis/iv/?format=json&sites=${USGS_HIGHROCK_SITE}&parameterCd=00065&startDT=${lastYearStart.toISOString()}&endDT=${lastYearEnd.toISOString()}`;
          const dataLY = await fetch(urlLY).then(r=>r.json());
          const arrLY = dataLY?.value?.timeSeries?.[0]?.values?.[0]?.value || [];
          let best = null, bestDiff = 1e15;
          const mid = new Date(today.getFullYear()-1, today.getMonth(), today.getDate()).getTime();
          for (const p of arrLY){
            const t = new Date(p.dateTime).getTime();
            const diff = Math.abs(t - mid);
            if (diff < bestDiff){ bestDiff = diff; best = toPoolFt(parseFloat(p.value)); }
          }
          if (best != null && Number.isFinite(best)){
            const d = nowFt - best;
            $('hrLastYear').textContent = `${best.toFixed(2)} ft (${d>=0?'+':'‚àí'}${Math.abs(d).toFixed(2)} ft vs now)`;
          } else {
            $('hrLastYear').textContent = '‚Äî';
          }
        } catch(e){ $('hrLastYear').textContent = '‚Äî'; }

        // Sparkline
        $('hrRange').textContent = `30‚Äëday range ${vmin.toFixed(2)}‚Äì${vmax.toFixed(2)} ft`;
        drawSparkline('hrSpark', series30, [
          { value: FULL_POND.highrock, color: '#eab308' },
          ...(statsToday ? [{ value: statsToday.median, color: '#22c55e' }] : [])
        ]);

        // CSV download
        $('dlCsv').onclick = () => {
          const rows = [['timestamp','elevation_ft']].concat(series30.map(p => [p.t.toISOString(), p.v.toFixed(3)]));
          const csv = rows.map(r => r.join(',')).join('\n');
          const blob = new Blob([csv], { type: 'text/csv' });
          const a = document.createElement('a');
          a.href = URL.createObjectURL(blob);
          a.download = 'high_rock_30day.csv';
          a.click();
          setTimeout(() => URL.revokeObjectURL(a.href), 1000);
        };
      } catch(err){
        console.error('loadHighRockDetails failed', err);
        document.getElementById('hrMeta').textContent = 'High Rock stats unavailable.';
      }
    }

    // --- Initial Load ---
    function initialLoad() {
      loadForecast();
      loadLakeLevels();
      loadHighRockDetails();
      initRadarAnimation();
    }

    document.getElementById('refreshBtn')?.addEventListener('click', initialLoad);
    
    // Run on page load
    initialLoad();

  </script>
</body>
</html>
