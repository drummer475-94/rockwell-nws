<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="theme-color" content="#0ea5e9" />
  <title>Rockwell, NC • NWS Forecast</title>
  <!-- Leaflet (map) -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""
  ></script>
  <style>
    :root {
      --bg: #0b1220;               /* dark mode default */
      --card: #0f172a;
      --muted: #94a3b8;
      --text: #e2e8f0;
      --accent: #38bdf8;           /* sky-400 */
      --accent-strong: #0ea5e9;    /* sky-500 */
      --ok: #22c55e;
      --warn: #f59e0b;
      --bad: #ef4444;
      --ring: rgba(56,189,248,.45);
      --shadow: 0 10px 25px rgba(2,6,23,.35);
    }
    @media (prefers-color-scheme: light) {
      :root {
        --bg: #f8fafc;
        --card: #ffffff;
        --muted: #475569;
        --text: #0f172a;
        --accent: #0284c7;
        --accent-strong: #0369a1;
        --ring: rgba(2,132,199,.2);
        --shadow: 0 8px 18px rgba(2,8,23,.08);
      }
    }

    html, body { height: 100%; }
    body {
      margin: 0;
      background: linear-gradient(180deg, var(--bg), #0b1328 50%, var(--bg));
      color: var(--text);
      font: 16px/1.4 system-ui, -apple-system, Segoe UI, Roboto, Inter, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
    }

    .container { max-width: 1100px; margin: 0 auto; padding: 16px; }

    header {
      position: sticky; top: 0; z-index: 40;
      backdrop-filter: blur(10px);
      background: color-mix(in oklab, var(--bg) 80%, transparent);
      border-bottom: 1px solid color-mix(in oklab, var(--muted) 25%, transparent);
    }
    .nav {
      display: flex; align-items: center; gap: 12px; padding: 10px 16px; max-width: 1100px; margin: 0 auto;
    }
    .title { font-weight: 800; letter-spacing: .2px; }
    .pill {
      display: inline-flex; gap: 8px; align-items: center;
      background: var(--card); color: var(--text);
      padding: 8px 12px; border-radius: 999px; border: 1px solid color-mix(in oklab, var(--muted) 25%, transparent);
      box-shadow: var(--shadow);
    }
    .btn {
      cursor: pointer; user-select: none;
      border: 0; padding: 8px 12px; border-radius: 10px;
      background: var(--accent); color: white; font-weight: 700;
      box-shadow: var(--shadow);
    }
    .btn:active { transform: translateY(1px); }

    .grid {
      display: grid; grid-template-columns: 1fr; gap: 16px; margin-top: 16px;
    }
    @media (min-width: 900px) {
      .grid { grid-template-columns: 1.15fr .85fr; }
    }

    .card {
      background: var(--card); border-radius: 18px; padding: 14px; box-shadow: var(--shadow);
      border: 1px solid color-mix(in oklab, var(--muted) 20%, transparent);
    }

    #radar { height: 360px; border-radius: 14px; overflow: hidden; }

    .row { display: flex; flex-wrap: wrap; gap: 12px; align-items: center; }
    .row.center { justify-content: center; }

    .kpis { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; }
    @media (min-width: 560px) { .kpis { grid-template-columns: repeat(4, 1fr); } }
    .kpi { background: color-mix(in oklab, var(--card) 96%, black); border: 1px dashed color-mix(in oklab, var(--muted) 25%, transparent); padding: 12px; border-radius: 12px; text-align: center; }
    .kpi .label { color: var(--muted); font-size: 12px; }
    .kpi .value { font-size: 22px; font-weight: 800; }

    .list { display: grid; grid-template-columns: 1fr; gap: 12px; }

    .hourlyScroller {
      display: grid; grid-auto-flow: column; grid-auto-columns: 66%; gap: 10px; overflow-x: auto; padding-bottom: 8px; scroll-snap-type: x mandatory;
    }
    @media (min-width: 560px) { .hourlyScroller { grid-auto-columns: 30%; } }
    @media (min-width: 900px) { .hourlyScroller { grid-auto-columns: 22%; } }

    .hourCard, .dayCard { scroll-snap-align: start; background: color-mix(in oklab, var(--card) 96%, black); border: 1px solid color-mix(in oklab, var(--muted) 25%, transparent); border-radius: 14px; padding: 12px; }
    .hourCard .top, .dayCard .top { display: flex; justify-content: space-between; gap: 10px; align-items: center; }
    .muted { color: var(--muted); font-size: 12px; }
    .temp { font-size: 24px; font-weight: 800; }

    .footnote { color: var(--muted); font-size: 12px; margin-top: 8px; }
    .lastUpdated { font-size: 12px; color: var(--muted); }

    .statusDot { width: 8px; height: 8px; border-radius: 999px; display: inline-block; background: var(--accent-strong); box-shadow: 0 0 0 4px var(--ring); }

    .loading { opacity: .7; }

    a, a:visited { color: var(--accent); text-decoration: none; }

    .attribution { font-size: 11px; color: var(--muted); display: flex; flex-wrap: wrap; gap: 6px; align-items: center; }
    .attribution span { white-space: nowrap; }
  </style>
</head>
<body>
  <header>
    <nav class="nav">
      <div class="pill" title="Live">
        <span class="statusDot"></span>
        <span>Rockwell, NC</span>
      </div>
      <div style="flex:1"></div>
      <strong class="title">NWS Forecast</strong>
      <div style="flex:1"></div>
      <button id="refreshBtn" class="btn" aria-label="Refresh forecast">Refresh</button>
    </nav>
  </header>

  <main class="container">
    <section class="grid">
      <div class="card">
        <h2 style="margin:6px 4px 10px">Radar</h2>
        <div id="radar" aria-label="Radar map for Rockwell, NC"></div>
        <div id="radarControls" class="row center" style="margin-top:10px; gap:10px">
          <button id="playBtn" class="btn" aria-label="Play/Pause radar animation">Play</button>
          <input id="frameSlider" type="range" min="0" max="0" value="0" style="flex:1; min-width:160px" aria-label="Radar time slider" />
          <span id="frameTime" class="muted">—</span>
        </div>
        <div class="footnote attribution" style="margin-top:8px">
          <span>Radar tiles: RainViewer (animated)</span>
          <span>•</span>
          <span>Fallback: NEXRAD (Iowa State Mesonet)</span>
          <span>•</span>
          <span>Map © OpenStreetMap</span>
        </div>
      </div>
      <div class="card">
        <h2 style="margin:6px 4px 10px">Right now</h2>
        <div class="kpis">
          <div class="kpi"><div class="label">Current Temp</div><div id="nowTemp" class="value">—</div></div>
          <div class="kpi"><div class="label">Heat Index</div><div id="heatIndex" class="value">—</div></div>
          <div class="kpi"><div class="label">Chance of Rain (6h)</div><div id="pop6" class="value">—</div></div>
          <div class="kpi"><div class="label">Wind (now)</div><div id="windNow" class="value">—</div></div>
        </div>
        <div style="display:flex;justify-content:space-between;align-items:center;margin-top:10px">
          <div class="lastUpdated" id="lastUpdated">Loading…</div>
          <div class="footnote">Data: <a href="https://api.weather.gov/" target="_blank" rel="noreferrer noopener">NWS</a></div>
        </div>
      </div>
    </section>

    <section class="card">
      <h2 style="margin:6px 4px 12px">Lake levels</h2>
      <div id="lakes" class="list"></div>
      <div class="footnote attribution" style="margin-top:8px">
        <span>Sources: USGS NWIS, NOAA NWPS, Cube Carolinas</span>
      </div>
    </section>

    <section class="card">
      <h2 style="margin:6px 4px 12px">Hourly (next 12 hours)</h2>
      <div id="hourly" class="hourlyScroller loading"></div>
    </section>

    <section class="card">
      <h2 style="margin:6px 4px 12px">Daily (next 7 days)</h2>
      <div id="daily" class="list loading"></div>
    </section>

    <p class="footnote">
      Tip: Add this page to your phone’s home screen for quick access. Values refresh when you tap <strong>Refresh</strong>.
    </p>
  </main>

  <script>
    // --- Configuration for Rockwell, NC ---
    const LAT = 35.551;   // Rockwell, NC approx
    const LON = -80.407;

    // --- Map (Leaflet + OSM base) ---
    const map = L.map('radar', { zoomControl: true, attributionControl: true }).setView([LAT, LON], 9);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 18,
      attribution: 'Map data © OpenStreetMap contributors'
    }).addTo(map);

    // Static fallback radar (NEXRAD via Iowa State Mesonet)
    const radarLayer = L.tileLayer(
      'https://mesonet.agron.iastate.edu/cache/tile.py/1.0.0/ridge::USCOMP-N0Q-0/{z}/{x}/{y}.png',
      { opacity: 0.6, zIndex: 500, attribution: 'Radar © Iowa State Mesonet / NWS NEXRAD' }
    ).addTo(map);

    const marker = L.circleMarker([LAT, LON], {
      radius: 6,
      color: '#0ea5e9',
      fillColor: '#38bdf8',
      fillOpacity: 0.95,
      weight: 2
    }).addTo(map).bindPopup('Rockwell, NC');

    // --- RainViewer animated radar (past hour + slider) ---
    let rainFrames = [];
    let rainLayer = null;
    let frameIndex = 0;
    let animTimer = null;
    let isPlaying = false;

    function rvFrameUrl(t){
      return `https://tilecache.rainviewer.com/v2/radar/${t}/256/{z}/{x}/{y}/2/1_1.png`;
    }

    function showFrame(i){
      if (!rainFrames.length) return;
      frameIndex = (i + rainFrames.length) % rainFrames.length;
      const t = rainFrames[frameIndex];
      if (rainLayer) {
        rainLayer.setUrl(rvFrameUrl(t));
      } else {
        rainLayer = L.tileLayer(rvFrameUrl(t), { opacity: 0.6, zIndex: 550 });
        rainLayer.addTo(map);
      }
      const slider = document.getElementById('frameSlider');
      const label = document.getElementById('frameTime');
      if (slider) slider.value = String(frameIndex);
      if (label) label.textContent = new Date(t * 1000).toLocaleString();
    }

    function play(){
      if (animTimer || !rainFrames.length) return;
      isPlaying = true; updatePlayBtn();
      animTimer = setInterval(() => showFrame(frameIndex + 1), 450);
    }
    function pause(){
      isPlaying = false; updatePlayBtn();
      if (animTimer) { clearInterval(animTimer); animTimer = null; }
    }
    function updatePlayBtn(){
      const btn = document.getElementById('playBtn');
      if (btn) btn.textContent = isPlaying ? 'Pause' : 'Play';
    }

    async function initRadarAnimation(){
      try {
        const res = await fetch('https://tilecache.rainviewer.com/api/maps.json');
        const data = await res.json();
        let frames = [];
        if (data && data.radar) {
          const past = Array.isArray(data.radar.past) ? data.radar.past : [];
          const nowc = Array.isArray(data.radar.nowcast) ? data.radar.nowcast : [];
          frames = past.concat(nowc).map(f => f.time).filter(Boolean);
        } else if (Array.isArray(data)) {
          // Older API shape: array of timestamps
          frames = data;
        }
        const nowSec = Math.floor(Date.now()/1000);
        // Keep only past ~60 minutes; if too few, fallback to last 12 frames
        let filtered = frames.filter(t => (nowSec - t) >= 0 && (nowSec - t) <= 3600);
        if (filtered.length < 3) filtered = frames.slice(-12);
        rainFrames = filtered;

        const slider = document.getElementById('frameSlider');
        if (rainFrames.length && slider) {
          slider.max = String(rainFrames.length - 1);
          showFrame(rainFrames.length - 1);
          // Prefer animated layer; remove static fallback to avoid double overlay
          if (typeof radarLayer !== 'undefined' && map.hasLayer(radarLayer)) {
            map.removeLayer(radarLayer);
          }
        } else {
          // Hide controls if we couldn't load frames
          const controls = document.getElementById('radarControls');
          if (controls) controls.style.display = 'none';
        }
      } catch (e) {
        console.error('RainViewer init failed', e);
        const controls = document.getElementById('radarControls');
        if (controls) controls.style.display = 'none';
      }
    }

    document.getElementById('playBtn')?.addEventListener('click', () => {
      if (isPlaying) pause(); else play();
    });
    document.getElementById('frameSlider')?.addEventListener('input', (e) => {
      pause();
      const v = parseInt(e.target.value, 10) || 0;
      showFrame(v);
    });

    initRadarAnimation();

    // --- Helpers ---
    const $ = (id) => document.getElementById(id);
    const fmtTime = (dStr, opts={}) => new Intl.DateTimeFormat(undefined, { hour: 'numeric', minute: '2-digit', ...opts }).format(new Date(dStr));
    const fmtDay = (dStr) => new Intl.DateTimeFormat(undefined, { weekday: 'short' }).format(new Date(dStr));

    // Heat Index (NOAA Rothfusz regression with adjustments)
    function heatIndexF(tempF, rh) {
      const T = tempF;
      const R = rh;
      if (T == null || R == null) return null;
      // If it's not warm/humid enough, heat index ~= T
      if (T < 80 || R < 40) return Math.round(T);
      let HI = -42.379 + 2.04901523*T + 10.14333127*R - 0.22475541*T*R - 0.00683783*T*T - 0.05481717*R*R + 0.00122874*T*T*R + 0.00085282*T*R*R - 0.00000199*T*T*R*R;
      // Adjustments
      if (R < 13 && T >= 80 && T <= 112) HI -= ((13 - R)/4) * Math.sqrt((17 - Math.abs(T - 95))/17);
      if (R > 85 && T >= 80 && T <= 87) HI += ((R - 85)/10) * ((87 - T)/5);
      return Math.round(HI);
    }

    // Probability of precipitation helper
    function popVal(obj) {
      if (!obj) return null;
      const v = obj.value; // % or null
      return typeof v === 'number' ? v : null;
    }

    function windNowText(period) {
      if (!period) return '—';
      const dir = period.windDirection || '';
      const spd = (period.windSpeed || '').replace(/ to /, '–');
      return `${dir} ${spd}`.trim() || '—';
    }

    // --- Fetch NWS endpoints ---
    async function loadForecast() {
      $('lastUpdated').textContent = 'Loading…';
      $('hourly').classList.add('loading');
      $('daily').classList.add('loading');

      const pointsUrl = `https://api.weather.gov/points/${LAT},${LON}`;
      const points = await fetch(pointsUrl, { headers: { 'Accept': 'application/geo+json' } }).then(r => r.json());

      const hourlyUrl = points?.properties?.forecastHourly;
      const dailyUrl  = points?.properties?.forecast;

      if (!hourlyUrl || !dailyUrl) {
        $('lastUpdated').textContent = 'Could not load NWS endpoints.';
        return;
      }

      const [hourly, daily] = await Promise.all([
        fetch(hourlyUrl, { headers: { 'Accept': 'application/geo+json' } }).then(r => r.json()),
        fetch(dailyUrl,  { headers: { 'Accept': 'application/geo+json' } }).then(r => r.json())
      ]);

      renderHourly(hourly?.properties?.periods || []);
      renderDaily(daily?.properties?.periods || []);

      // KPIs (now = first hourly period)
      const now = (hourly?.properties?.periods || [])[0];
      const nowTemp = now?.temperature;
      const nowRH = now?.relativeHumidity?.value;
      const nowHI = heatIndexF(nowTemp, nowRH);
      $('nowTemp').textContent = nowTemp != null ? `${Math.round(nowTemp)}°F` : '—';
      $('heatIndex').textContent = nowHI != null ? `${nowHI}°F` : '—';
      $('windNow').textContent = windNowText(now);

      // Chance of rain next 6h (max of next 6 hourly pops)
      const next6 = (hourly?.properties?.periods || []).slice(0, 6);
      const pops = next6.map(p => popVal(p.probabilityOfPrecipitation)).filter(v => typeof v === 'number');
      const maxPop = pops.length ? Math.max(...pops) : NaN;
      $('pop6').textContent = isFinite(maxPop) ? `${Math.round(maxPop)}%` : '—';

      $('lastUpdated').textContent = 'Updated ' + new Intl.DateTimeFormat(undefined, { dateStyle: 'medium', timeStyle: 'short' }).format(new Date());
    }

    function renderHourly(periods) {
      const cont = $('hourly');
      cont.innerHTML = '';
      periods.slice(0, 12).forEach(p => {
        const div = document.createElement('div');
        div.className = 'hourCard';
        const icon = p.icon ? `<img src="${p.icon}" alt="${p.shortForecast}" style="width:36px;height:36px;border-radius:8px;object-fit:cover"/>` : '';
        const pop = popVal(p.probabilityOfPrecipitation);
        div.innerHTML = `
          <div class="top">
            <div>
              <div class="muted">${fmtDay(p.startTime)} • ${fmtTime(p.startTime)}</div>
              <div class="temp">${Math.round(p.temperature)}°F</div>
            </div>
            ${icon}
          </div>
          <div class="muted" style="margin-top:6px">${p.shortForecast || ''}</div>
          <div class="row" style="margin-top:8px">
            <div class="pill" title="Chance of precipitation"><span>🌧️</span><strong>${isFinite(pop) ? pop + '%' : '—'}</strong></div>
            <div class="pill" title="Wind"><span>💨</span><strong>${windNowText(p)}</strong></div>
          </div>
        `;
        cont.appendChild(div);
      });
      cont.classList.remove('loading');
    }

    function renderDaily(periods) {
      const cont = $('daily');
      cont.innerHTML = '';
      // Use daytime periods for a clean 7-day overview
      const days = periods.filter(p => p.isDaytime).slice(0, 7);
      days.forEach(p => {
        const div = document.createElement('div');
        div.className = 'dayCard';
        const pop = popVal(p.probabilityOfPrecipitation);
        const icon = p.icon ? `<img src="${p.icon}" alt="${p.shortForecast}" style="width:44px;height:44px;border-radius:10px;object-fit:cover"/>` : '';
        div.innerHTML = `
          <div class="top">
            <div>
              <div style="font-weight:800">${p.name}</div>
              <div class="muted">${p.shortForecast || ''}</div>
            </div>
            ${icon}
          </div>
          <div class="row" style="margin-top:10px">
            <div class="pill"><span>🌡️</span><strong>${Math.round(p.temperature)}°F</strong></div>
            <div class="pill"><span>🌧️</span><strong>${isFinite(pop) ? pop + '%' : '—'}</strong></div>
            <div class="pill"><span>💨</span><strong>${windNowText(p)}</strong></div>
          </div>
        `;
        cont.appendChild(div);
      });
      cont.classList.remove('loading');
    }

    // --- Lake Levels (High Rock & Tuckertown) ---
    const USGS_HIGHROCK_SITE = '02122500';
    const USGS_HIGHROCK_DATUM_FT = 558.68; // NGVD29 (USGS inventory)
    const FULL_POND = { highrock: 655, tuckertown: 596 };

    async function fetchHighRockFromUSGS(){
      try {
        const url = `https://waterservices.usgs.gov/nwis/iv/?format=json&sites=${USGS_HIGHROCK_SITE}&parameterCd=00065&siteStatus=all`;
        const data = await fetch(url).then(r => r.json());
        const ts = data?.value?.timeSeries?.[0];
        const arr = ts?.values?.[0]?.value || [];
        const last = arr[arr.length - 1];
        const gageFt = parseFloat(last?.value);
        const when = last?.dateTime;
        if (isFinite(gageFt)) {
          return { value: +(USGS_HIGHROCK_DATUM_FT + gageFt).toFixed(2), when, src: 'USGS' };
        }
      } catch(err){ console.warn('USGS fetch failed', err); }
      return null;
    }

    async function fetchFromCube(){
      // Uses a read-only text proxy to avoid CORS issues
      try {
        const html = await fetch('https://r.jina.ai/http://cubecarolinas.com/lake-levels/').then(r => r.text());
        const get = (name) => {
          const re = new RegExp(name + "[^0-9]*([0-9]{3}\\.[0-9]{2})", 'i');
          const m = html.match(re);
          return m ? parseFloat(m[1]) : null;
        };
        const hr = get('High Rock');
        const tt = get('Tuckertown');
        const now = new Date().toISOString();
        return { highrock: hr != null ? { value: +hr.toFixed(2), when: now, src: 'Cube Carolinas' } : null,
                 tuckertown: tt != null ? { value: +tt.toFixed(2), when: now, src: 'Cube Carolinas' } : null };
      } catch(err){ console.warn('Cube levels fetch failed', err); }
      return { highrock: null, tuckertown: null };
    }

    async function fetchHighRockFromNOAA(){
      try {
        const text = await fetch('https://r.jina.ai/http://water.noaa.gov/gauges/hgrn7').then(r => r.text());
        const m = text.match(/Pool \(FT\)[^0-9]*([0-9]{3}\.[0-9]+)/i);
        if (m) return { value: +parseFloat(m[1]).toFixed(2), when: new Date().toISOString(), src: 'NOAA NWPS' };
      } catch(err){ console.warn('NOAA NWPS fetch failed', err); }
      return null;
    }

    function renderLakeLevels(vals){
      const cont = $('lakes');
      if (!cont) return;
      cont.innerHTML = '';
      const addRow = (label, item, full) => {
        const div = document.createElement('div');
        div.className = 'dayCard';
        let valueText = '—';
        let sub = '';
        if (item && isFinite(item.value)) {
          const diff = (full != null) ? +(full - item.value).toFixed(2) : null;
          const dir = diff != null ? (diff >= 0 ? 'below' : 'above') : '';
          const mag = diff != null ? Math.abs(diff).toFixed(2) : '';
          valueText = `${item.value.toFixed(2)} ft`;
          sub = (diff != null) ? `${mag} ft ${dir} full (${full} ft)` : '';
        }
        div.innerHTML = `
          <div class="top">
            <div>
              <div style="font-weight:800">${label}</div>
              <div class="muted">${sub || ''}</div>
            </div>
            <div class="temp">${valueText}</div>
          </div>
          <div class="footnote">${item?.src ? 'Source: ' + item.src : ''}</div>
        `;
        cont.appendChild(div);
      };
      addRow('High Rock Lake', vals.highrock, FULL_POND.highrock);
      addRow('Tuckertown Lake', vals.tuckertown, FULL_POND.tuckertown);
    }

    async function loadLakeLevels(){
      const vals = { highrock: null, tuckertown: null };
      // Try operator site first for both
      const cube = await fetchFromCube();
      if (cube.highrock) vals.highrock = cube.highrock;
      if (cube.tuckertown) vals.tuckertown = cube.tuckertown;
      // High Rock fallbacks
      if (!vals.highrock) vals.highrock = await fetchHighRockFromUSGS();
      if (!vals.highrock) vals.highrock = await fetchHighRockFromNOAA();
      renderLakeLevels(vals);
    }

    // Refresh button
    $('refreshBtn').addEventListener('click', () => {
      loadForecast().catch(err => {
        console.error(err);
        $('lastUpdated').textContent = 'Refresh failed. Try again.';
      });
      loadLakeLevels().catch(console.error);
    });

    // Initial load
    loadForecast().catch(err => {
      console.error(err);
      $('lastUpdated').textContent = 'Failed to load data.';
    });
    loadLakeLevels().catch(console.error);
  </script>
</body>
</html>
